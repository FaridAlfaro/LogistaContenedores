@hostname = localhost
@port = 8080
@host = http://{{hostname}}:{{port}}
@keycloak = http://{{hostname}}:8088

# Credenciales del Cliente Oauth2 (backend-client)
@clientId = backend-client
@clientSecret = backend-secret

# ==========================================
#  SECCIN DE AUTENTICACIN (Ejecutar primero)
# ==========================================

### 1. Login OPERADOR (Obtiene y guarda el token autom谩ticamente)
# @name loginOperador
POST {{keycloak}}/realms/tpi-backend/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password
&client_id={{clientId}}
&client_secret={{clientSecret}}
&username=operador
&password=operador

### Variable para usar el token de operador
@tokenOp = {{loginOperador.response.body.access_token}}


### 2. Login TRANSPORTISTA
# @name loginTransportista
POST {{keycloak}}/realms/tpi-backend/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password
&client_id={{clientId}}
&client_secret={{clientSecret}}
&username=transportista
&password=transportista

### Variable para usar el token de transportista
@tokenTrans = {{loginTransportista.response.body.access_token}}


### 3. Login CLIENTE (Necesario para crear solicitudes seg煤n tu SecurityConfig)
# Aseg煤rate de tener un usuario 'cliente' en Keycloak con rol 'CLIENTE'
# @name loginCliente
POST {{keycloak}}/realms/tpi-backend/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password
&client_id={{clientId}}
&client_secret={{clientSecret}}
&username=cliente
&password=cliente

### Variable para usar el token de cliente
@tokenCli = {{loginCliente.response.body.access_token}}


# ==========================================
# 锔 VARIABLES GLOBALES DE IDs
# ==========================================
# Actualiza estos valores manualmente si reinicias la base de datos
# o usa las respuestas de las peticiones de creaci贸n.

@idDeposito = 1
@idTarifa = 1
@idTransportista = 1
@idCamion = 1
# Este valor se intenta capturar autom谩ticamente en el paso de creaci贸n de solicitud
@nroSolicitud = SOL-2024-001 
@idTramo = 1


# ==========================================
#  FLUJO 1: MICROSERVICIO SOLICITUDES
# ==========================================

### 1.1. Crear Solicitud (Rol: CLIENTE)
# @name crearSolicitud
POST {{host}}/api/v1/solicitudes
Authorization: Bearer {{tokenCli}}
Content-Type: application/json

{
  "idCliente": "cliente-juan",
  "idContenedor": "CONT-999",
  "origen": {
    "dir": "Puerto Buenos Aires",
    "lat": -34.6037,
    "lon": -58.3816
  },
  "destino": {
    "dir": "C贸rdoba Capital",
    "lat": -31.4201,
    "lon": -64.1888
  }
}

### Guardar el Nro de Solicitud generado autom谩ticamente
# @nroSolicitudGenerado = {{crearSolicitud.response.body.nroSolicitud}}


### 1.2. Listar Pendientes (Rol: OPERADOR)
GET {{host}}/api/v1/solicitudes/pendientes
Authorization: Bearer {{tokenOp}}


### 1.3. Aceptar Solicitud (Rol: OPERADOR)
# Usa la variable capturada o la manual si fall贸 la captura
PUT {{host}}/api/v1/solicitudes/{{crearSolicitud.response.body.nroSolicitud}}/aceptar
Authorization: Bearer {{tokenOp}}


# ==========================================
#  FLUJO 2: MICROSERVICIO LOGSTICA
# ==========================================

### 2.1. Crear Dep贸sito (Rol: OPERADOR)
POST {{host}}/api/v1/depositos
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

{
  "nombre": "Centro Log铆stico Rosario",
  "direccion": "Av. Circunvalaci贸n 123",
  "latitud": -32.9442,
  "longitud": -60.6505,
  "costoEstadiaDiario": 5000.0
}

### 2.2. Crear Tarifa (Rol: OPERADOR)
POST {{host}}/api/v1/tarifas
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

{
  "valorKMBase": 200.0,
  "costoLitroCombustible": 950.0,
  "fechaVigencia": "2024-11-01"
}

### 2.3. Planificar Ruta (Rol: OPERADOR)
# Calcula tramos y costos para la solicitud aceptada
# @name planificarRuta
POST {{host}}/api/v1/rutas/planificar
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

{
  "nroSolicitud": "{{crearSolicitud.response.body.nroSolicitud}}",
  "idDepositos": [], 
  "latOrigen": -34.6037,
  "lonOrigen": -58.3816,
  "latDestino": -31.4201,
  "lonDestino": -64.1888,
  "idTarifa": {{idTarifa}}
}

### Guardar el ID del primer Tramo generado
@idTramoGenerado = {{planificarRuta.response.body.ruta.tramos[0].id}}


# ==========================================
#  FLUJO 3: MICROSERVICIO FLOTA
# ==========================================

### 3.1. Crear Transportista (Rol: OPERADOR)
POST {{host}}/api/flota/transportistas
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

{
  "nombre": "Log铆stica Express SA",
  "licencia": "L-99887766",
  "contacto": "contacto@logisticaexpress.com"
}

### 3.2. Crear Cami贸n (Rol: OPERADOR)
# @name crearCamion
POST {{host}}/api/flota/camiones
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

{
  "dominio": "AA 555 BB",
  "capacidadPeso": 25000.0,
  "capacidadVolumen": 80.0,
  "idTransportista": {{idTransportista}},
  "costoPorKm": 150.0,
  "consumoCombustiblePromedio": 3.0
}

### 3.3. Obtener Camiones Disponibles (Rol: OPERADOR)
POST {{host}}/api/flota/camiones/disponibles
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

{
  "capacidadPesoRequerida": 1000.0,
  "capacidadVolumenRequerida": 10.0
}

### 3.4. Iniciar Tramo (Rol: TRANSPORTISTA)
# Asignamos el cami贸n y arrancamos el viaje
POST {{host}}/api/flota/tramos/{{idTramoGenerado}}/iniciar
Authorization: Bearer {{tokenTrans}}
Content-Type: application/json

{
  "dominioCamion": "AA 555 BB"
}

### 3.5. Finalizar Tramo (Rol: TRANSPORTISTA)
POST {{host}}/api/flota/tramos/{{idTramoGenerado}}/finalizar
Authorization: Bearer {{tokenTrans}}
Content-Type: application/json

{
  "dominioCamion": "AA 555 BB",
  "kmRecorridos": 750.0
}