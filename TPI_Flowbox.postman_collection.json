{
	"info": {
		"_postman_id": "flowbox-tpi-v3-fixed",
		"name": "TPI FlowBox - Flujo Corregido (Auto-Token)",
		"description": "Colección con scripts de captura de token corregidos. Las carpetas gestionan la autorización automáticamente usando las variables capturadas.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "0. Autenticación (Ejecutar Primero)",
			"item": [
				{
					"name": "Login OPERADOR",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"",
									"// 1. Validar que recibimos el token",
									"if (pm.response.code === 200 && jsonData.access_token) {",
									"    // 2. Guardar en variable de colección",
									"    pm.collectionVariables.set(\"tokenOp\", jsonData.access_token);",
									"    console.log(\"✅ Token OPERADOR guardado exitosamente.\");",
									"} else {",
									"    console.error(\"❌ Error obteniendo token.\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/x-www-form-urlencoded" }
						],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{ "key": "grant_type", "value": "password", "type": "text" },
								{ "key": "client_id", "value": "{{clientId}}", "type": "text" },
								{ "key": "client_secret", "value": "{{clientSecret}}", "type": "text" },
								{ "key": "username", "value": "operador", "type": "text" },
								{ "key": "password", "value": "operador", "type": "text" }
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/tpi-backend/protocol/openid-connect/token",
							"host": ["{{keycloakUrl}}"],
							"path": ["realms", "tpi-backend", "protocol", "openid-connect", "token"]
						}
					}
				},
				{
					"name": "Login TRANSPORTISTA",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if (jsonData.access_token) {",
									"    pm.collectionVariables.set(\"tokenTrans\", jsonData.access_token);",
									"    console.log(\"✅ Token TRANSPORTISTA guardado.\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/x-www-form-urlencoded" }
						],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{ "key": "grant_type", "value": "password", "type": "text" },
								{ "key": "client_id", "value": "{{clientId}}", "type": "text" },
								{ "key": "client_secret", "value": "{{clientSecret}}", "type": "text" },
								{ "key": "username", "value": "transportista", "type": "text" },
								{ "key": "password", "value": "transportista", "type": "text" }
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/tpi-backend/protocol/openid-connect/token",
							"host": ["{{keycloakUrl}}"],
							"path": ["realms", "tpi-backend", "protocol", "openid-connect", "token"]
						}
					}
				},
				{
					"name": "Login CLIENTE",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if (jsonData.access_token) {",
									"    pm.collectionVariables.set(\"tokenCli\", jsonData.access_token);",
									"    console.log(\"✅ Token CLIENTE guardado.\");",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/x-www-form-urlencoded" }
						],
						"body": {
							"mode": "urlencoded",
							"urlencoded": [
								{ "key": "grant_type", "value": "password", "type": "text" },
								{ "key": "client_id", "value": "{{clientId}}", "type": "text" },
								{ "key": "client_secret", "value": "{{clientSecret}}", "type": "text" },
								{ "key": "username", "value": "cliente", "type": "text" },
								{ "key": "password", "value": "cliente", "type": "text" }
							]
						},
						"url": {
							"raw": "{{keycloakUrl}}/realms/tpi-backend/protocol/openid-connect/token",
							"host": ["{{keycloakUrl}}"],
							"path": ["realms", "tpi-backend", "protocol", "openid-connect", "token"]
						}
					}
				}
			]
		},
		{
			"name": "1. Datos Maestros (Rol: OPERADOR)",
			"item": [
				{
					"name": "1.1 Crear Tarifa",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if(jsonData.id) pm.collectionVariables.set(\"idTarifa\", jsonData.id);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"valorKMBase\": 200.0,\n  \"costoLitroCombustible\": 950.0,\n  \"fechaVigencia\": \"2024-01-01\"\n}",
							"options": { "raw": { "language": "json" } }
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/tarifas",
							"host": ["{{baseUrl}}"],
							"path": ["api", "v1", "tarifas"]
						}
					}
				},
				{
					"name": "1.2 Crear Depósito",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if(jsonData.id) pm.collectionVariables.set(\"idDeposito\", jsonData.id);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"nombre\": \"Centro Logístico Rosario\",\n  \"direccion\": \"Av. Circunvalación 123\",\n  \"latitud\": -32.9442,\n  \"longitud\": -60.6505,\n  \"costoEstadiaDiario\": 5000.0\n}",
							"options": { "raw": { "language": "json" } }
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/depositos",
							"host": ["{{baseUrl}}"],
							"path": ["api", "v1", "depositos"]
						}
					}
				},
				{
					"name": "1.3 Crear Transportista",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if(jsonData.id) pm.collectionVariables.set(\"idTransportista\", jsonData.id);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"nombre\": \"Logística Express SA\",\n  \"licencia\": \"LIC-998877\",\n  \"contacto\": \"contacto@logistica.com\"\n}",
							"options": { "raw": { "language": "json" } }
						},
						"url": {
							"raw": "{{baseUrl}}/api/flota/transportistas",
							"host": ["{{baseUrl}}"],
							"path": ["api", "flota", "transportistas"]
						}
					}
				},
				{
					"name": "1.4 Crear Camión",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if(jsonData.dominio) pm.collectionVariables.set(\"dominioCamion\", jsonData.dominio);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"dominio\": \"AA555BB\",\n  \"capacidadPeso\": 25000.0,\n  \"capacidadVolumen\": 80.0,\n  \"idTransportista\": {{idTransportista}},\n  \"costoPorKm\": 150.0,\n  \"consumoCombustiblePromedio\": 3.0\n}",
							"options": { "raw": { "language": "json" } }
						},
						"url": {
							"raw": "{{baseUrl}}/api/flota/camiones",
							"host": ["{{baseUrl}}"],
							"path": ["api", "flota", "camiones"]
						}
					}
				}
			],
			"auth": {
				"type": "bearer",
				"bearer": [
					{ "key": "token", "value": "{{tokenOp}}", "type": "string" }
				]
			}
		},
		{
			"name": "2. Solicitudes (Rol: CLIENTE)",
			"item": [
				{
					"name": "2.1 Crear Solicitud",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if(jsonData.numeroSolicitud) pm.collectionVariables.set(\"nroSolicitud\", jsonData.numeroSolicitud);"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"idCliente\": \"cliente-juan\",\n  \"idContenedor\": \"CONT-2024-X\",\n  \"origen\": {\n    \"dir\": \"Puerto Buenos Aires\",\n    \"lat\": -34.6037,\n    \"lon\": -58.3816\n  },\n  \"destino\": {\n    \"dir\": \"Córdoba Capital\",\n    \"lat\": -31.4201,\n    \"lon\": -64.1888\n  }\n}",
							"options": { "raw": { "language": "json" } }
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/solicitudes",
							"host": ["{{baseUrl}}"],
							"path": ["api", "v1", "solicitudes"]
						}
					}
				}
			],
			"auth": {
				"type": "bearer",
				"bearer": [
					{ "key": "token", "value": "{{tokenCli}}", "type": "string" }
				]
			}
		},
		{
			"name": "3. Planificación (Rol: OPERADOR)",
			"item": [
				{
					"name": "3.1 Listar Pendientes",
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/solicitudes/pendientes",
							"host": ["{{baseUrl}}"],
							"path": ["api", "v1", "solicitudes", "pendientes"]
						}
					}
				},
				{
					"name": "3.2 Aceptar Solicitud",
					"request": {
						"method": "PUT",
						"header": [],
						"url": {
							"raw": "{{baseUrl}}/api/v1/solicitudes/{{nroSolicitud}}/aceptar",
							"host": ["{{baseUrl}}"],
							"path": ["api", "v1", "solicitudes", "{{nroSolicitud}}", "aceptar"]
						}
					}
				},
				{
					"name": "3.3 Planificar Ruta",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"var jsonData = pm.response.json();",
									"if(jsonData.tramos && jsonData.tramos.length > 0) {",
									"    pm.collectionVariables.set(\"idTramo1\", jsonData.tramos[0].id);",
									"    console.log(\"Tramo capturado: \" + jsonData.tramos[0].id);",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"nroSolicitud\": \"{{nroSolicitud}}\",\n  \"idDepositos\": [], \n  \"latOrigen\": -34.6037,\n  \"lonOrigen\": -58.3816,\n  \"latDestino\": -31.4201,\n  \"lonDestino\": -64.1888,\n  \"idTarifa\": {{idTarifa}}\n}",
							"options": { "raw": { "language": "json" } }
						},
						"url": {
							"raw": "{{baseUrl}}/api/v1/rutas/planificar",
							"host": ["{{baseUrl}}"],
							"path": ["api", "v1", "rutas", "planificar"]
						}
					}
				}
			],
			"auth": {
				"type": "bearer",
				"bearer": [
					{ "key": "token", "value": "{{tokenOp}}", "type": "string" }
				]
			}
		},
		{
			"name": "4. Viajes (Rol: TRANSPORTISTA)",
			"item": [
				{
					"name": "4.1 Iniciar Tramo",
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"dominioCamion\": \"{{dominioCamion}}\"\n}",
							"options": { "raw": { "language": "json" } }
						},
						"url": {
							"raw": "{{baseUrl}}/api/flota/tramos/{{idTramo1}}/iniciar",
							"host": ["{{baseUrl}}"],
							"path": ["api", "flota", "tramos", "{{idTramo1}}", "iniciar"]
						}
					}
				},
				{
					"name": "4.2 Finalizar Tramo",
					"request": {
						"method": "POST",
						"header": [],
						"body": {
							"mode": "raw",
							"raw": "{\n  \"dominioCamion\": \"{{dominioCamion}}\",\n  \"kmRecorridos\": 350.5\n}",
							"options": { "raw": { "language": "json" } }
						},
						"url": {
							"raw": "{{baseUrl}}/api/flota/tramos/{{idTramo1}}/finalizar",
							"host": ["{{baseUrl}}"],
							"path": ["api", "flota", "tramos", "{{idTramo1}}", "finalizar"]
						}
					}
				}
			],
			"auth": {
				"type": "bearer",
				"bearer": [
					{ "key": "token", "value": "{{tokenTrans}}", "type": "string" }
				]
			}
		}
	],
	"variable": [
		{ "key": "baseUrl", "value": "http://localhost:8080", "type": "string" },
		{ "key": "keycloakUrl", "value": "http://localhost:8088", "type": "string" },
		{ "key": "clientId", "value": "backend-client", "type": "string" },
		{ "key": "clientSecret", "value": "backend-secret", "type": "string" },
		{ "key": "tokenOp", "value": "", "type": "string" },
		{ "key": "tokenTrans", "value": "", "type": "string" },
		{ "key": "tokenCli", "value": "", "type": "string" },
		{ "key": "idTransportista", "value": "", "type": "string" },
		{ "key": "idTarifa", "value": "", "type": "string" },
		{ "key": "idDeposito", "value": "", "type": "string" },
		{ "key": "nroSolicitud", "value": "", "type": "string" },
		{ "key": "dominioCamion", "value": "", "type": "string" },
		{ "key": "idTramo1", "value": "", "type": "string" }
	]
}