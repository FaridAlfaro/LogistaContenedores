@hostname = localhost
@port = 8080
@host = http://{{hostname}}:{{port}}
@keycloak = http://{{hostname}}:8088

# Credenciales Oauth2
@clientId = backend-client
@clientSecret = backend-secret

# ==========================================
# üîê 0. AUTENTICACI√ìN (Ejecutar primero)
# ==========================================

### 1. Login OPERADOR (Obtiene y guarda el token autom√°ticamente)
# @name loginOperador
POST {{keycloak}}/realms/tpi-backend/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password
&client_id={{clientId}}
&client_secret={{clientSecret}}
&username=operador
&password=operador

### Variable para usar el token de operador
@tokenOp = {{loginOperador.response.body.access_token}}

### 2. Login TRANSPORTISTA
# @name loginTransportista
POST {{keycloak}}/realms/tpi-backend/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password
&client_id={{clientId}}
&client_secret={{clientSecret}}
&username=transportista
&password=transportista

### Variable para usar el token de transportista
@tokenTrans = {{loginTransportista.response.body.access_token}}


### 3. Login CLIENTE (Necesario para crear solicitudes seg√∫n tu SecurityConfig)
# Aseg√∫rate de tener un usuario 'cliente' en Keycloak con rol 'CLIENTE'
# @name loginCliente
POST {{keycloak}}/realms/tpi-backend/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=password
&client_id={{clientId}}
&client_secret={{clientSecret}}
&username=cliente
&password=cliente

### Variable para usar el token de cliente
@tokenCli = {{loginCliente.response.body.access_token}}



# ==========================================
# üõ†Ô∏è 1. CONFIGURACI√ìN DE DATOS MAESTROS (Req 15)
# ==========================================
# "Registrar y actualizar dep√≥sitos, camiones y tarifas."

### 1.1 Crear Tarifa Vigente
# @name crearTarifa
POST {{host}}/api/v1/tarifas
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

{
  "valorKMBase": 200.0,
  "costoLitroCombustible": 950.0,
  "fechaVigencia": "2024-01-01"
}
@idTarifa = {{crearTarifa.response.body.id}}

### 1.2 Crear Dep√≥sito Intermedio
# @name crearDeposito
POST {{host}}/api/v1/depositos
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

{
  "nombre": "Centro Log√≠stico Rosario",
  "direccion": "Av. Circunvalaci√≥n 123",
  "latitud": -32.9442,
  "longitud": -60.6505,
  "costoEstadiaDiario": 5000.0
}
@idDeposito = {{crearDeposito.response.body.id}}

### 1.3 Crear Transportista
# @name crearTransportista
POST {{host}}/api/flota/transportistas
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

{
  "nombre": "Log√≠stica Express SA",
  "licencia": "LIC-998877",
  "contacto": "contacto@logistica.com"
}
@idTransportista = {{crearTransportista.response.body.id}}

### 1.3 Consultar Camiones
GET {{host}}/api/flota/camiones
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

### 1.4 Crear Cami√≥n (Validaci√≥n de Capacidad - Req 16)
# @name crearCamion
POST {{host}}/api/flota/camiones
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

{
  "dominio": "AA555BB",
  "capacidadPeso": 25000.0,
  "capacidadVolumen": 80.0,
  "idTransportista": {{idTransportista}},
  "costoPorKm": 150.0,
  "consumoCombustiblePromedio": 3.0
}


# ==========================================
# üì¶ 2. GESTI√ìN DE SOLICITUDES (CLIENTE)
# ==========================================

### 2.1 Registrar Nueva Solicitud (Req 1, 2, 3, 4)
# "Registrar solicitud... creaci√≥n del contenedor... registro cliente... estado borrador"
# @name crearSolicitud
POST {{host}}/api/v1/solicitudes
Authorization: Bearer {{tokenCli}}
Content-Type: application/json

{
  "idCliente": "cliente-juan",
  "idContenedor": "CONT-2024-X",
  "origen": {
    "dir": "Puerto Buenos Aires",
    "lat": -34.6037,
    "lon": -58.3816
  },
  "destino": {
    "dir": "C√≥rdoba Capital",
    "lat": -31.4201,
    "lon": -64.1888
  }
}

### Capturar Nro Solicitud
@nroSolicitud = {{crearSolicitud.response.body.numeroSolicitud}}

### 2.2 Consultar Estado del Transporte (Req 5)
# "Consultar el estado del transporte de un contenedor"
GET {{host}}/api/v1/solicitudes/{{nroSolicitud}}
Authorization: Bearer {{tokenCli}}


# ==========================================
# üó∫Ô∏è 3. PLANIFICACI√ìN (OPERADOR)
# ==========================================

### 3.1 Consultar Pendientes (Req 8)
# "Consultar contenedores pendientes... con filtros"
GET {{host}}/api/v1/solicitudes/pendientes
Authorization: Bearer {{tokenOp}}

### 3.2 Aceptar Solicitud (Paso previo a planificar)
PUT {{host}}/api/v1/solicitudes/{{nroSolicitud}}/aceptar
Authorization: Bearer {{tokenOp}}

### 3.3 Consultar Rutas Tentativas (Req 6)
# "Consultar rutas tentativas... tiempo y costo estimados"
GET {{host}}/api/v1/rutas/calcular?latOrigen=-34.6037&lonOrigen=-58.3816&latDestino=-31.4201&lonDestino=-64.1888&idTarifa={{idTarifa}}&idDepositos={{idDeposito}}
Authorization: Bearer {{tokenOp}}

### 3.4 Asignar Ruta y Tramos (Req 7)
# "Asignar una ruta con todos sus tramos a la solicitud"
# @name planificarRuta
POST {{host}}/api/v1/rutas/planificar
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

{
  "nroSolicitud": "{{nroSolicitud}}",
  "idDepositos": [{{idDeposito}}], 
  "latOrigen": -34.6037,
  "lonOrigen": -58.3816,
  "latDestino": -31.4201,
  "lonDestino": -64.1888,
  "idTarifa": {{idTarifa}}
}

### Capturar IDs de los Tramos generados
# Asumimos que se generan al menos 2 tramos (Origen->Deposito, Deposito->Destino)
@idTramo1 = {{planificarRuta.response.body.tramos[0].id}}
@idTramo2 = {{planificarRuta.response.body.tramos[1].id}}


# ==========================================
# üöõ 4. EJECUCI√ìN DEL VIAJE (OPERADOR/TRANSPORTISTA)
# ==========================================

### 4.1 Buscar Cami√≥n Disponible (Req 9 - Paso previo)
POST {{host}}/api/flota/camiones/disponibles
Authorization: Bearer {{tokenOp}}
Content-Type: application/json

{
  "capacidadPesoRequerida": 1000.0,
  "capacidadVolumenRequerida": 10.0
}

### 4.2 Asignar Cami√≥n e Iniciar Tramo 1 (Req 9 y 10)
# "Asignar cami√≥n... Determinar inicio de un tramo"
# Nota: En este dise√±o de API, asignar e iniciar ocurren juntos o requieren rol Transportista.
POST {{host}}/api/flota/tramos/{{idTramo1}}/iniciar
Authorization: Bearer {{tokenTrans}}
Content-Type: application/json

{
  "dominioCamion": "AA555BB"
}

### 4.3 Finalizar Tramo 1 (Req 10, 11, 12)
# "Determinar fin... Calcular costo real... Registrar c√°lculo"
POST {{host}}/api/flota/tramos/{{idTramo1}}/finalizar
Authorization: Bearer {{tokenTrans}}
Content-Type: application/json

{
  "dominioCamion": "AA555BB",
  "kmRecorridos": 300.0
}

### 4.4 Iniciar Tramo 2 (Salida del Dep√≥sito)
POST {{host}}/api/flota/tramos/{{idTramo2}}/iniciar
Authorization: Bearer {{tokenTrans}}
Content-Type: application/json

{
  "dominioCamion": "AA555BB"
}

### 4.5 Finalizar Tramo 2 (Entrega Final)
POST {{host}}/api/flota/tramos/{{idTramo2}}/finalizar
Authorization: Bearer {{tokenTrans}}
Content-Type: application/json

{
  "dominioCamion": "AA555BB",
  "kmRecorridos": 450.0
}


# ==========================================
# üèÅ 5. VERIFICACI√ìN FINAL
# ==========================================

### 5.1 Consultar Estado Final y Costos (Req 11, 12, 5)
# El estado deber√≠a ser ENTREGADA y contener los costos reales calculados
GET {{host}}/api/v1/solicitudes/{{nroSolicitud}}
Authorization: Bearer {{tokenCli}}